{% extends "base.html" %}
 {% block content %}
<div class="container">
    <h3 class="my-3">Tính doanh thu</h3>
    <form action="{% url 'cal_benefit' pk_doctor %}" id="cal_benefit_form" method="get">
        {% csrf_token %}
        <div class="form-row align-items-end">
            <div class="col-md-4 mb-3">
                <label for="from_date">Từ ngày<span class="required-input">*</span></label>
                <input type="text" name="from_date" class="form-control" placeholder="ngày / tháng / năm" id="from_date" autocomplete="off"
                {% if form.from_date.value %}
                value="{{ form.from_date.value }}"
                {% endif %}>
                <span id="alert_from_date" style="color: #d9534f;font-size:15px"></span>
            </div>
            <div class="col-md-4 mb-3">
                <label for="to_date">Đến ngày<span class="required-input">*</span></label>
                <input type="text" id="to_date" name="to_date" class="form-control" placeholder="ngày / tháng / năm" autocomplete="off" id="to_date" 
                {% if form.from_date.value %}
                value="{{ form.to_date.value }}"
                {% endif %}>
                <span id="alert_to_date" style="color: #d9534f;font-size:15px"></span>
            </div>
            <div class="col-md-4">
                <button class="btn btn-submit mb-3" type="button">Xác nhận</button>
            </div>
        </div>
    </form>

    
    {% if histories_object %}
    
    <h6 class="my-3">Số ca đã Siêu Âm/Nội Soi/Xét Nghiệm: <span class="" style="color: #d9534f">{{count_ultrasonography }}/{{count_endoscopy }}/{{count_medical_test }}</span> </h6>
    <h6 class="my-3">Tổng số ca khám: <span class="convert_number" style="color: #d9534f">{{count_histories }}</span> </h6>
    
    {% if ultrasonography_revenue != 0 %}
    <h6 class="my-3">Doanh thu siêu âm (VNĐ): <span class="convert_number" style="color: #d9534f">{{ultrasonography_revenue }}</span> </h6> 
    {% endif %}
    {% if endoscopy_revenue != 0 %}
    <h6 class="my-3">Doanh thu nội soi (VNĐ): <span class="convert_number" style="color: #d9534f">{{endoscopy_revenue }}</span> </h6> 
    {% endif %}
    {% if medical_test_revenue != 0 %}
    <h6 class="my-3">Doanh thu xét nghiệm (VNĐ): <span class="convert_number" style="color: #d9534f">{{medical_test_revenue }}</span> </h6> 
    {% endif %}
        
    <h5 class="my-3">Tổng doanh thu (VNĐ): <span class="convert_number" style="color: #d9534f">{{gross_revenue }}</span> </h5>
    <h5 class="my-3">Tổng lợi nhuận(VNĐ): <span class="convert_number"  style="color: #00796B">{{ gross_profit }}</span> </h5>

    <h5 class="my-3">Danh sách bệnh nhân đã khám</h5>
    <table class="table">
        <thead>
            <tr>
                <th>Họ và tên</th>
                <th>Ngày khám</th>
                <th>Tiền siêu âm (VNĐ)</th>
                <th>Tiền xét nghiệm (VNĐ)</th>
                <th>Tiền thuốc (VNĐ)</th>
                <th>Tiền khám (VNĐ)</th>
                <th>Doanh thu (VNĐ)</th>
            </tr>
        </thead>
        <tbody>
            {% for history in histories_object %}
            <tr>
                <td scope="row"><a tabindex="0" class="btn btn-link" role="button" data-popover-content="#{{ forloop.counter0 }}" data-toggle="popover" data-placement="right" data-container="body">{{ history.history.medical_record.full_name }}</a></td>
                <div id="{{ forloop.counter0 }}" style="display:none;">                   
                    <div>
                        <p>Siêu âm 1: <span  class="convert_number">{{ history.history.medical_ultrasonography_cost }}</span> VNĐ</p>
                    </div>
                    <div>
                        <p>Siêu âm 2: <span  class="convert_number">{{ history.history.medical_ultrasonography_cost_2 }}</span> VNĐ</p>
                    </div>
                    <div>
                        <p>Siêu âm 3: <span  class="convert_number">{{ history.history.medical_ultrasonography_cost_3 }}</span> VNĐ</p>
                    </div>
                    <hr>
                    <div>
                        <p>Xét nghiệm 1: <span  class="convert_number">{{ history.history.medical_test_cost }}</span> VNĐ</p>
                    </div>
                    <div>
                        <p>Xét nghiệm 2: <span  class="convert_number">{{ history.history.medical_test_cost_2 }}</span> VNĐ</p>
                    </div>
                    <div>
                        <p>Xét nghiệm 3: <span  class="convert_number">{{ history.history.medical_test_cost_3 }}</span> VNĐ</p>
                    </div>
                    <hr>
                    <div>
                        <p>Bán thuốc: <span  class="convert_number">{{ history.revenue_drug }}</span> VNĐ</p>
                    </div>
                    <div>
                        <p>Nhập thuốc: <span  class="convert_number">{{ history.expense_drug }}</span> VNĐ</p>
                    </div>
                    <div>
                        <p>Lợi nhuận: <span  class="convert_number">{{ history.benefit_drug }}</span> VNĐ</p>
                    </div>
                    <hr>
                    <div>
                        <p>Tiền khám: <span  class="convert_number">{{ history.history.medical_examination_cost }}</span> VNĐ</p>
                    </div>
                    <hr>
                    <div>
                        <p>Tổng doanh thu: <span  class="convert_number">{{ history.total_revenue}}</span> VNĐ</p>
                    </div>
                    <div>
                        <p>Tổng lợi nhuận: <span  class="convert_number">{{ history.total_benefit }}</span> VNĐ</p>
                    </div>
                </div> 
                <td>{{ history.history.date |date:"P  d-m-Y"}}</td>
                <td class="convert_number">{{ history.ultra_cost }}</td>
                <td class="convert_number">{{ history.test_cost }}</td>
                <td class="convert_number">{{ history.revenue_drug }}</td>
                <td class="convert_number">{{ history.history.medical_examination_cost }}</td>
                <td class="convert_number"> {{ history.total_revenue }}</td>
                   
            </tr>
            
            {% endfor %}            
        </tbody>
        
    </table>
    
        
    {% endif %}
        
</div>

<script>
$(document).ready(function(){

    $(".convert_number").each(function() {
      let cost = parseInt($(this).text());
      $(this).text(cost.toLocaleString());
    }); // end each

    // validate datetime format dd/mm/Y
    function ValidateDate(value){
      regex = new RegExp("^([0-2]\\d{1}|3[0-1])\\/(0\\d{1}|1[0-2])\\/(19|20)\\d{2}$");
      var isValid = regex.test(value);
      return isValid;
    }
    // date picker
    $("#from_date").datepicker({
    dateFormat: "dd/mm/yy",
    changeMonth: true,
    changeYear: true,
    yearRange:"-90:+0",
    monthNames: ["1","2","3","4","5","6","7","8","9","10","11","12"],
    monthNamesShort: ["1","2","3","4","5","6","7","8","9","10","11","12"]
    });// end datepicker
    $("#to_date").datepicker({
    dateFormat: "dd/mm/yy",
    changeMonth: true,
    changeYear: true,
    yearRange:"-90:+0",
    monthNames: ["1","2","3","4","5","6","7","8","9","10","11","12"],
    monthNamesShort: ["1","2","3","4","5","6","7","8","9","10","11","12"]
    });// end datepicker

    $(".btn-submit").click(function(){
        var from_date = $("#from_date").val();
        var to_date = $("#to_date").val();

        var valid = true;

        if(!ValidateDate(from_date)){
            $("#alert_from_date").text("Chọn ngày không hợp lệ");
            valid &= false;
        } else{
            $("#alert_from_date").text("");
        }
        if(!ValidateDate(to_date)){
            $("#alert_to_date").text("Chọn ngày không hợp lệ");
            valid &= false;
        } else{
            $("#alert_to_date").text("");
        }

        if(valid){
            $("#cal_benefit_form").submit();
        }
    }); // end click

    // popover
	$(function () {
      $('[data-toggle="popover"]').popover({
        html : true,
        content: function() {
          var content = $(this).attr("data-popover-content");
          return $(content).html();
        }
      });
    }); //end popper

    $('.popover-dismiss').popover({
    //   trigger: 'focus',
    }); // end popper


    // patient report tree
    var toggler = document.getElementsByClassName("caret");

    for (var i = 0; i < toggler.length; i++) {
    toggler[i].addEventListener("click", function() {
        this.parentElement.querySelector(".nested").classList.toggle("active");
        console.log(this.parentElement);
        this.classList.toggle("caret-down");
        });
    }


}); // end ready
</script>

 {% endblock %}