{% extends "base.html" %} {% block content %}

<div class="container">
  <h2 class="mt-3">Kê toa thuốc</h2>

  <div class="input-group mb-3 search_drug_form">
    <input
      type="text"
      class="form-control"
      placeholder="Nhập tên thuốc cần tìm"
      id="search_drug"
    />
    <div class="input-group-append">
      <span class="input-group-text btn-finished" id="basic-addon2"
        >Tìm thuốc</span
      >
    </div>
  </div>

  {% if medicine_list %}

  <h6 class="artical_search">Danh sách thuốc tìm kiếm</h6>
  <div class="table_search">
    <table class="table">
      <thead>
        <tr>
          <th>Tên thuốc</th>
          <th>Số lượng</th>
          <th>Giá bán (VNĐ)</th>
          <th>Giá mua (VNĐ)</th>
        </tr>
      </thead>

      <tbody>
        {% for drug in medicine_list %}
        <tr>
          <td scope="row">
            <a
              class="page-link-mix"
              href="{% url 'take_drug' pk_doctor pk_mrecord pk_history drug.pk %}"
              >{{ drug.full_name }}</a
            >
          </td>
          <td>{{ drug.quantity }}</td>
          <td class="sale_price">{{ drug.sale_price }}</td>
          <td class="import_price">{{ drug.import_price }}</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
  {% endif %} {% if history.prescriptiondrug_set.all %}
  <h6>Danh sách thuốc đã thêm vào toa</h6>

  <table class="table text-center">
    <thead>
      <tr>
        <th>Tên Thuốc</th>
        <th>Liều lượng</th>
        <th>Số lượng</th>
        <th>Giá tiền</th>
        <th>Thời gian uống</th>
        <th>Xóa khỏi toa</th>
      </tr>
    </thead>
    {% for drug in history.prescriptiondrug_set.all %}
    <tbody>
      <tr>
        <td scope="row">{{ drug.medicine.full_name }}</td>
        <td>{{ drug.dose }}</td>
        <td>{{ drug.quantity }}</td>
        <td class="cost_drug">{{ drug.cost }}</td>
        <td>{{ drug.time_take_medicine }}</td>
        <td>
          <a
            class="icon_remove"
            href="{% url 'remove_drug' pk_doctor pk_mrecord pk_history drug.pk %}"
            ><i class="fa fa-times-circle"></i
          ></a>
        </td>
      </tr>
    </tbody>
    {% endfor %}
  </table>
  {% else %}
  <h5 class="mt-3">Chưa thêm thuốc vào toa!</h5>
  {% endif %}

  <button class="btn btn-back mt-4">
    <a
      href="{% url 'medical_record_back_view' pk_doctor pk_mrecord pk_history %}"
      >Quay lại</a
    >
  </button>
  <button class="btn btn-submit ml-3 mt-4" type="button">
    <a href="{% url 'final_info' pk_doctor pk_mrecord pk_history %}"
      >Tiếp theo</a
    >
  </button>
  <button class="btn btn-del float-right mt-4" type="button">
    <a href="{% url 'medical_history_del' pk_doctor pk_mrecord pk_history %}"
      >Huỷ</a
    >
  </button>
</div>

<script>
  $(document).ready(function() {
    $(".sale_price").each(function() {
      let cost = parseInt($(this).text());
      $(this).text(cost.toLocaleString());
    }); // end each
    $(".import_price").each(function() {
      let cost = parseInt($(this).text());
      $(this).text(cost.toLocaleString());
    }); // end each

    $(".cost_drug").each(function() {
      let cost = parseInt($(this).text());
      $(this).text(cost.toLocaleString() + " VNĐ");
    }); // end each

    // search drug
    let artical_search = $(".artical_search");
    let table_search = $(".table_search");
    let medicine_list = $(".table_search tbody tr");
    artical_search.hide();
    table_search.hide();
    search_drug();

    // function search drug
    function search_drug() {
      $("#search_drug").focus(function() {
        $(this).keyup(function() {
          let value_search = $(this)
            .val()
            .trim()
            .toString();
          console.log(value_search);

          if (value_search === "") {
            table_search.hide();
            artical_search.hide();
          } else {
            artical_search.show();
            table_search.show();
            medicine_list.hide();
            let show_hide = false;
            medicine_list.each(function() {
              let full_name = $(this)
                .find("td a")
                .eq(0);
              console.log(full_name.text());

              if (
                full_name
                  .text()
                  .toLowerCase()
                  .includes(value_search.toLowerCase())
              ) {
                $(this).show();
                show_hide = true;
                console.log("true");
              } else {
                $(this).hide();
              }
              if (!show_hide) {
                artical_search.hide();
                table_search.hide();
                console.log("hide");
              }else{
                artical_search.show();
                table_search.show();
              }
            }); //end each
          }
        }); // end keyup
      }); // end focus
    } // end func
  }); // end ready
</script>

{% endblock %}
