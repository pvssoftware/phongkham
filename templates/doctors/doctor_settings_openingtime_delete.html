{% extends "base.html" %}
 {% block content %}

<div class="container my-3" style="border: solid #f7f7f9;border-width: 3px;">
    <h3 class="mt-3">Cài đặt giờ khám chữa bệnh</h3>

    <form action="{% url 'settings_openingtime' doctor.user.pk %}" id="form_settings" method="post">
        {% csrf_token %}
        <div class="form-check my-3">
            <input class="form-check-input" type="checkbox" id="enable_voice" name="enable_voice" 

            {% if doctor.opening_time.enable_voice %}
                checked
            {% endif %}
            >
            <label class="form-check-label" for="enable_voice" id="enable_label">
              Kích hoạt dịch vụ đặt lịch khám bằng điện thoại
            </label>
        </div>

        <div class="d-flex justify-content-between align-items-center opening-time">
           <span class="mt-4 font-weight-bold day-label">THỨ HAI</span>
            <div class="form-row" style="width: 200px;">
                <div class="col-6">
                    <label for="mon_opening">Giờ mở</label>
                    <input type="text" class="form-control timepicker" id="mon_opening" name="mon_opening" onkeydown="return false" 
                    
                    {% if doctor.opening_time.mon_opening %}
                        value="{{doctor.opening_time.mon_opening|date:'H:i'}}"
                    {% endif %}
                        >
                    <small id="alert_mon_opening" class="text-muted" style="color: #d9534f !important;"></small>
                </div>
                <div class="col-6">
                    <label for="mon_closing">Giờ đóng</label>
                    <input type="text" class="form-control timepicker" id="mon_closing" name="mon_closing" onkeydown="return false" 
                    {% if doctor.opening_time.mon_closing %}
                        value="{{doctor.opening_time.mon_closing|date:'H:i'}}"
                    {% endif %}
                        >
                    <small id="alert_mon_closing" class="text-muted" style="color: #d9534f !important;"></small>
                </div>
            </div> 
        </div>
        

        <div class="d-flex justify-content-between align-items-center  opening-time my-3">
            <span class="font-weight-bold align-self-center day-label">THỨ BA</span>
             <div class="form-row"  style="width: 200px;">
                 <div class="col-6">
                     
                     <input type="text" class="form-control timepicker" id="tue_opening" name="tue_opening" onkeydown="return false" 

                     {% if doctor.opening_time.tue_opening %}
                        value="{{doctor.opening_time.tue_opening|date:'H:i'}}"
                    {% endif %}
                    >
                     <small id="alert_tue_opening" class="text-muted" style="color: #d9534f !important;"></small>
                 </div>
                 <div class="col-6">
                     
                     <input type="text" class="form-control timepicker" id="tue_closing" name="tue_closing" onkeydown="return false"
                     
                     {% if doctor.opening_time.tue_closing %}
                        value="{{doctor.opening_time.tue_closing|date:'H:i'}}"
                    {% endif %}
                    >
                     <small id="alert_tue_closing" class="text-muted" style="color: #d9534f !important;"></small>
                 </div>
             </div> 
        </div>
        <div class="d-flex justify-content-between align-items-center  opening-time my-3">
            <span class="font-weight-bold align-self-center day-label">THỨ TƯ</span>
             <div class="form-row"  style="width: 200px;">
                 <div class="col-6">
                     
                     <input type="text" class="form-control timepicker" id="wed_opening" name="wed_opening" onkeydown="return false"
                     {% if doctor.opening_time.wed_opening %}
                        value="{{doctor.opening_time.wed_opening|date:'H:i'}}"
                    {% endif %}>
                     <small id="alert_wed_opening" class="text-muted" style="color: #d9534f !important;"></small>
                 </div>
                 <div class="col-6">
                     
                     <input type="text" class="form-control timepicker" id="wed_closing" name="wed_closing" onkeydown="return false"
                     
                     {% if doctor.opening_time.wed_closing %}
                        value="{{doctor.opening_time.wed_closing|date:'H:i'}}"
                    {% endif %}>
                     <small id="alert_wed_closing" class="text-muted" style="color: #d9534f !important;"></small>
                 </div>
             </div> 
        </div>
        <div class="d-flex justify-content-between align-items-center  opening-time my-3">
            <span class="font-weight-bold align-self-center day-label">THỨ NĂM</span>
             <div class="form-row"  style="width: 200px;">
                 <div class="col-6">
                     
                     <input type="text" class="form-control timepicker" id="thu_opening" name="thu_opening" onkeydown="return false"
                     {% if doctor.opening_time.thu_opening %}
                        value="{{doctor.opening_time.thu_opening|date:'H:i'}}"
                    {% endif %}>
                     <small id="alert_thu_opening" class="text-muted" style="color: #d9534f !important;"></small>
                 </div>
                 <div class="col-6">
                     
                     <input type="text" class="form-control timepicker" id="thu_closing" name="thu_closing" onkeydown="return false" 
                     
                     {% if doctor.opening_time.thu_closing %}
                        value="{{doctor.opening_time.thu_closing|date:'H:i'}}"
                    {% endif %}>
                     <small id="alert_thu_closing" class="text-muted" style="color: #d9534f !important;"></small>
                 </div>
             </div> 
        </div>
        <div class="d-flex justify-content-between align-items-center  opening-time my-3">
            <span class="font-weight-bold align-self-center day-label">THỨ SÁU</span>
             <div class="form-row"  style="width: 200px;">
                 <div class="col-6">
                     
                     <input type="text" class="form-control timepicker" id="fri_opening" name="fri_opening" onkeydown="return false" 
                     
                     {% if doctor.opening_time.fri_opening %}
                        value="{{doctor.opening_time.fri_opening|date:'H:i'}}"
                    {% endif %}>
                     <small id="alert_fri_opening" class="text-muted" style="color: #d9534f !important;"></small>
                 </div>
                 <div class="col-6">
                     
                     <input type="text" class="form-control timepicker" id="fri_closing" name="fri_closing" onkeydown="return false" 
                     
                     {% if doctor.opening_time.fri_closing %}
                        value="{{doctor.opening_time.fri_closing|date:'H:i'}}"
                    {% endif %}>
                     <small id="alert_fri_closing" class="text-muted" style="color: #d9534f !important;"></small>
                 </div>
             </div> 
        </div>
        <div class="d-flex justify-content-between align-items-center  opening-time my-3">
            <span class="font-weight-bold align-self-center day-label">THỨ BẢY</span>
             <div class="form-row"  style="width: 200px;">
                 <div class="col-6">
                     
                     <input type="text" class="form-control timepicker" id="sat_opening" name="sat_opening" onkeydown="return false" 
                     
                     {% if doctor.opening_time.sat_opening %}
                        value="{{doctor.opening_time.sat_opening|date:'H:i'}}"
                    {% endif %}>
                     <small id="alert_sat_opening" class="text-muted" style="color: #d9534f !important;"></small>
                 </div>
                 <div class="col-6">
                     
                     <input type="text" class="form-control timepicker" id="sat_closing" name="sat_closing" onkeydown="return false" 
                     
                     {% if doctor.opening_time.sat_closing %}
                        value="{{doctor.opening_time.sat_closing|date:'H:i'}}"
                    {% endif %}>
                     <small id="alert_sat_closing" class="text-muted" style="color: #d9534f !important;"></small>
                 </div>
             </div> 
        </div>
        <div class="d-flex justify-content-between align-items-center  opening-time my-3">
            <span class="font-weight-bold align-self-center day-label">CHỦ NHẬT</span>
             <div class="form-row"  style="width: 200px;">
                 <div class="col-6">
                     
                     <input type="text" class="form-control timepicker" id="sun_opening" name="sun_opening" onkeydown="return false" 
                     
                     {% if doctor.opening_time.sun_opening %}
                        value="{{doctor.opening_time.sun_opening|date:'H:i'}}"
                    {% endif %}>
                     <small id="alert_sun_opening" class="text-muted" style="color: #d9534f !important;"></small>
                 </div>
                 <div class="col-6">
                     
                     <input type="text" class="form-control timepicker" id="sun_closing" name="sun_closing" onkeydown="return false" 
                     
                     {% if doctor.opening_time.sun_closing %}
                        value="{{doctor.opening_time.sun_closing|date:'H:i'}}"
                    {% endif %}>
                     <small id="alert_sun_closing" class="text-muted" style="color: #d9534f !important;"></small>
                 </div>
             </div> 
        </div>

        <div class="form-group d-flex justify-content-between align-items-center opening-time">
            <label for="examination_period" class="align-self-center day-label">Thời gian dự kiến khám cho mỗi bệnh nhân</label>
            <div class="" style="width: 100px;">
              <input type="text" class="form-control" id="examination_period" aria-describedby="helptext" name="examination_period" placeholder="Số phút" 
              
              {% if doctor.opening_time.examination_period %}
                    value="{{doctor.opening_time.examination_period}}"
                {% endif %}>
              <small id="alert_examination_period"  class="text-muted" style="color: #d9534f !important;"></small>
            </div>
            
        </div>
        

        <button class="btn btn-submit my-3" type="button">Xác nhận</button>
    </form>
</div>

<script>
$(document).ready(function(){
    // validate digital
    function ValidateDigit(value) {
      regex = new RegExp("^[1-9][0-9]*$");
      var isValid = regex.test(value);
      return isValid;
    }
    // Time picker
    $(".timepicker").datetimepicker({
        datepicker: false,
        format: "H:i",
        step: 30,
        // mask:true
    }); // end datetimepicker
    // check whenther voice service enabled or not
    if($("#enable_voice").prop("checked")){
        $(".timepicker").prop("disabled",false);
        $("#examination_period").prop("disabled",false);
        $(".day-label").css("color","");
        $("#enable_label").css("color","");
    } else{
        $(".timepicker").prop("disabled",true);
        $("#examination_period").prop("disabled",true);
        $(".day-label").css("color","#e9ecef");
        $("#enable_label").css("color","#d9534f");
            
    }
    // enable voice service
    $("#enable_voice").click(function(){
        if($(this).prop("checked")){
            $(".timepicker").prop("disabled",false);
            $("#examination_period").prop("disabled",false);
            $(".day-label").css("color","");
            $("#enable_label").css("color","");
        } else{
            $(".timepicker").prop("disabled",true);
            $("#examination_period").prop("disabled",true);
            $(".day-label").css("color","#e9ecef");
            $("#enable_label").css("color","#d9534f");
            
        }
    })

    // Function return time object
    function time_working(params1=null,params2=null) {
        opening = new Date();
        closing = new Date();
        if (params1) {
           return opening.setHours(parseInt(params1.split(":")[0]),parseInt(params1.split(":")[1])) 
        } else {
            return closing.setHours(parseInt(params2.split(":")[0]),parseInt(params2.split(":")[1])) 
        }
        
    }

    // Valid function
    function ValidTime(time_opening,time_closing,alert_opening,alert_closing) {
        if(time_opening !== "" && time_closing !== ""){
                if (time_working(params1=time_opening,params2=null) >= time_working(params1=null,params2=time_closing)){
                    
                    $(alert_opening).text("Không hợp lệ!");
                    $(alert_closing).text("Không hợp lệ!");
                    return false
                } else {
                    $(alert_opening).text("");
                    $(alert_closing).text("");
                    return true
                }
        } else if (time_opening !== "") {
                    console.log("opening");
                    
                    $(alert_opening).text("");
                    $(alert_closing).text("Không hợp lệ!");
                    return false
        } else if (time_closing !== "") {
                    
                    $(alert_opening).text("Không hợp lệ!");
                    $(alert_closing).text("");
                    return false
        } else {
                $(alert_opening).text("");
                $(alert_closing).text("");
                return true
        }
    }
    // submit form
    $(".btn-submit").click(function(){
        var valid = true;
        var mon_opening = $("#mon_opening").val();
        var mon_closing = $("#mon_closing").val();
        var tue_opening = $("#tue_opening").val();
        var tue_closing = $("#tue_closing").val();
        var wed_opening = $("#wed_opening").val();
        var wed_closing = $("#wed_closing").val();
        var thu_opening = $("#thu_opening").val();
        var thu_closing = $("#thu_closing").val();
        var fri_opening = $("#fri_opening").val();
        var fri_closing = $("#fri_closing").val();
        var sat_opening = $("#sat_opening").val();
        var sat_closing = $("#sat_closing").val();
        var sun_opening = $("#sun_opening").val();
        var sun_closing = $("#sun_closing").val();
        var examination_period = $("#examination_period").val();

        var enable_voice = $("#enable_voice").prop("checked");
        console.log(mon_opening);
        


        if (enable_voice === true){
            valid &= ValidTime(mon_opening,mon_closing,"#alert_mon_opening","#alert_mon_closing");
            valid &= ValidTime(tue_opening,tue_closing,"#alert_tue_opening","#alert_tue_closing");
            valid &= ValidTime(wed_opening,wed_closing,"#alert_wed_opening","#alert_wed_closing");
            valid &= ValidTime(thu_opening,thu_closing,"#alert_thu_opening","#alert_thu_closing");
            valid &= ValidTime(fri_opening,fri_closing,"#alert_fri_opening","#alert_fri_closing");
            valid &= ValidTime(sat_opening,sat_closing,"#alert_sat_opening","#alert_sat_closing");
            valid &= ValidTime(sun_opening,sun_closing,"#alert_sun_opening","#alert_sun_closing");
            if (!ValidateDigit(examination_period)){
                $("#alert_examination_period").text("Không hợp lệ!");
                valid &= false;
            } else {
                $("#alert_examination_period").text("");
            }

            if(valid){
                $("#form_settings").submit(); 
            }       

        } else{
            $("#form_settings").submit();
        }

    }); // end click


})
</script>

 {% endblock %}